<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>CS2D</title>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="matchesPanel">
        <div id="statusOutput">Ready</div>
        <label for="demoInput">Open Demo File:</label>
        <input type="file" id="demoInput" name="demo" accept=".dem" />

        <label for="matchHistoryButton">Load from URL:</label>
        <button id="matchHistoryButton">Match History</button>
        <input id="matchHistoryUrlInput" type="text" placeholder="input match url here"
            value="http://replay190.valve.net/730/003654969677295124605_0866816312.dem.bz2"></input>
        <button id="loadMatchButton">Load</button>
        <select name="maps" id="mapDropdown">
            <option value="cs_italy">Italy</option>
            <option value="cs_office">Office</option>
            <option value="de_ancient">Ancient</option>
            <option value="de_anubis">Anubis</option>
            <option value="de_dust2">Dust 2</option>
            <option value="de_inferno">Inferno</option>
            <option value="de_mirage">Mirage</option>
            <option selected value="de_nuke">Nuke</option>
            <option value="de_overpass">Overpass</option>
            <option value="de_vertigo">Vertigo</option>
        </select>
        <div style="display: flex;flex-direction: column; display:none">
            <label for="scale">scale</label>
            <input type="range" id="scale" step="any" min=3000 max=9000
                oninput="scale=this.value; drawFrame(currentTick, resultTicks);">
            <label for="xOffset">xOffset</label>
            <input type="range" id="xOffset" step="any" min=-6000 max=6000
                oninput="xOffset=this.value; drawFrame(currentTick, resultTicks);">
            <label for="yOffset">yOffset</label>
            <input type="range" id="yOffset" step="any" min=-6000 max=6000
                oninput="yOffset=this.value; drawFrame(currentTick, resultTicks);">
            <button onclick="printScale()">print</button>
        </div>
    </div>
    <div id="mapPanel">
        <input type="range" id="progressBar" step="any" list="roundTicks">
        <datalist id="roundTicks">
            <option value="0"></option>
            <option value="100"></option>
        </datalist>

        <canvas id="canvas"></canvas>
    </div>
</body>

<script src="ui.js"></script>
<script type="module">
    import init, { parseEvent, parseTicks } from './pkg/demoparser2.js';
    //import * as demoparser2 from './node_modules/demoparser2/demoparser2.js';
    import SevenZip from "./node_modules/7z-wasm/7zz.es6.js";
    const sevenZip = await SevenZip();
    await init();



    loadMatchButton.addEventListener("click", function () {
        let url = matchHistoryUrlInput.value;
        downloadDemo(url);
    })
    async function parseDemo(uint8Array) {
        setStatus("analyzing");
        drawHtmlThenContinueWith(function () {


            // const eventNames = [
            //     "begin_new_match", "round_start", "round_end", "round_mvp",
            //     "player_death", "bomb_planted", "bomb_defused", "hostage_rescued",
            //     "weapon_fire", "flashbang_detonate", "hegrenade_detonate",
            //     "molotov_detonate", "smokegrenade_detonate", "player_hurt",
            //     "player_blind"
            // ];



            //resultEvents = parseEvent(uint8Array, "player_death", [], ["total_rounds_played", "is_warmup_period"]);
            // resultTicks = parseTicks(uint8Array, ["X", "Y"], [firstParsedTick, lastParsedTick]);
            //parseTicks(path: string, wantedProps: Array<string>, wantedTicks?: Array<number> | undefined | null, structOfArrays?: boolean | undefined | null): any
            // resultTicks = parseTicks(uint8Array, ["X", "Y"]);


            // allEvents = parseEvent(uint8Array, [], ["is_warmup_period"]);

            // const matchStartTick = allEvents.find(event => event.event_name === "begin_new_match")?.tick || 0;
            // const roundStartEvents = allEvents.filter(event => event.event_name === "round_start");
            // const roundEndEvents = allEvents.filter(event => event.event_name === "round_end" && event.tick >= matchStartTick);

            roundStartEvents = parseEvent(uint8Array, "round_start", ["is_warmup_period"]);
            roundEndEvents = parseEvent(uint8Array, "round_end", ["is_warmup_period"]);
            roundsTotal = parseEvent(uint8Array, "team_score_first_half", ["is_warmup_period"]);


            let from = 64 * 100;
            let to = 64 * 110;
            let requestedTicks = [from, to];
            requestedTicks = null;
            resultTicks = parseTicks(uint8Array, ["X", "Y", "yaw", "is_alive"], [], true);
            //allEvents = allEvents.filter(event => event.tick >= matchStartTick);
            currentTick = Math.round((to - from) / 2);

            clearStatus();
            addRoundTicks(roundStartEvents);
            drawFrame(currentTick, resultTicks);
            let a = 1;
        });
    }



    async function downloadDemo(url) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', proxyUrl + url, true);
        xhr.responseType = 'arraybuffer';
        xhr.send();
        xhr.onprogress = function (evt) {
            let progress = Math.round((evt.loaded / evt.total) * 100);
            setStatus("downloading demo", progress);
        };
        xhr.onload = function () {
            setStatus("unzipping");
            drawHtmlThenContinueWith(function () {
                var archiveData = new Uint8Array(xhr.response);
                const archiveName = "newDemo.dem.bz2";
                const stream = sevenZip.FS.open(archiveName, "w+");
                sevenZip.FS.write(stream, archiveData, 0, archiveData.length);
                sevenZip.FS.close(stream);
                const filesToExtract = ["newDemo.dem"];

                let cpuCores = Math.round(navigator.hardwareConcurrency / 2);
                // sevenZip.callMain(["e", archiveName, "-bb1", ...filesToExtract]);
                sevenZip.callMain(["x", archiveName, '-y', ...filesToExtract]);

                let unzippedFile = sevenZip.FS.readFile(filesToExtract[0]);


                parseDemo(unzippedFile);
            });

        }
    }

    function drawHtmlThenContinueWith(functionToDoAfterWards) {
        setTimeout(functionToDoAfterWards, 1);
    }

</script>
<script src="draw.js"></script>

</html>